# J2安定配置の理論メモ（SSモデル零ドリフト条件）

## 1. 目的と前提

- 近円軌道の相対運動を扱う **Schweighart–Sedwick (SS) 拡張** HCW 方程式（docs/impact-of-J2.md 参照）を前提とする。
- 「J2込でも比較的安定な配置」とは、SS 方程式で生じる **ドリフト項（有界解以外の線形成長）** を初期状態で打ち消し、残りを周期解に制限した編隊を指す。
- 実装的には「J2 摂動を有効にした状態でも `\dot{y} + 2ncx = 0` が成立する初期条件」を生成できれば、平面内の解は有界となり、古典 HCW の周期解設計をそのまま流用できる。

以下では記号 $n$（平均運動）, $c$（SS 係数, docs/impact-of-J2.md 式 (3.2)）, $s$（補助量）, $\omega_p$, $\omega_z$ を用いる。$c>0$ で LEO 想定では $c^2 < 2$ が成立するため $\omega_p = n\sqrt{2-c^2}$, $\omega_z = n\sqrt{3c^2-2}$ は実数になる。

## 2. SS 方程式の再掲

平面内と面外の SS 方程式（同次系）は以下。

$$
\begin{aligned}
\ddot{x} - 2nc\,\dot{y} - (5c^2 - 2)n^2 x &= 0,\\
\ddot{y} + 2nc\,\dot{x} &= 0,\\
\ddot{z} + (3c^2 - 2)n^2 z &= 0.
\end{aligned}
$$

ここで $c = \sqrt{1 + s}$, $s = \dfrac{3J_2 R_e^2}{8 r_0^2}(1 + 3\cos^2 i)$。$c \to 1$ で古典 HCW に一致する。

## 3. 平面内解の構造とドリフト定数

第 2 式を積分すると

$$
K \equiv \dot{y} + 2nc\,x = \text{const}.
$$

この $K$ がゼロでないと、平面内解に線形成長項が残り J2 を含むドリフトが発生する。$K$ を右辺に代入して整理すると、$x(t)$ は

$$
x(t) = A\cos(\omega_p t) + B\sin(\omega_p t) + C_x,
$$

$$
C_x = \frac{2c}{(2 - c^2)n}\,K, \qquad \omega_p = n\sqrt{2 - c^2}.
$$

対応する $y(t)$ は

$$
y(t) = -\frac{2nc}{\omega_p}A\sin(\omega_p t) + \frac{2nc}{\omega_p}B\cos(\omega_p t) + \frac{2 - 5c^2}{2 - c^2} K\, t + D,
$$

であり、$K \neq 0$ のときにのみ $y$ 成分へ線形成長（ドリフト）が現れる。$K=0$ なら $C_x = 0$ となり、$x,y$ とも純粋な周期解だけが残る。古典 HCW の $C$・$-\tfrac{3}{2}nCt$ と同じ役割を $K$ が担うと理解できる。

## 4. 零ドリフト条件（J2安定配置）

初期状態 $[x_0, y_0, z_0, \dot{x}_0, \dot{y}_0, \dot{z}_0]$ からは

$$
K = \dot{y}_0 + 2nc\,x_0.
$$

従って

$$
\boxed{\dot{y}_0 = -2nc\,x_0}
$$

を満たせば $K = 0$ となり、J2 込みでも平面内ドリフトが完全に抑制される。これは HCW の周知条件 $\dot{y}_0 = -2nx_0$ に $c$ を掛けただけである。$c \to 1$ に戻すと古典式を再現できる点が検証手順になる。

面外方向は

$$
z(t) = E\cos(\omega_z t) + F\sin(\omega_z t), \qquad \omega_z = n\sqrt{3c^2 - 2}
$$

で純粋な調和振動のままなので、$E = z_0$, $F = \dot{z}_0/\omega_z$ を用意すればよい。

## 5. 実装メモ

- **係数の供給**: HillEquationSolver で内部計算済みの $c$ を getter で公開し、OrbitInitializer から参照できるようにする。$\omega_p$, $\omega_z$ も同時に返すと初期状態生成が楽になる。
- **配置アルゴリズム**: 既存の円盤配置（docs/diskOrbit.md）で使っている $\dot{y}_0 = -2nx_0$ を、J2 摂動有効時には $\dot{y}_0 = -2ncx_0$ に置き換えるだけで零ドリフト条件を満たせる。その他の速度（$\dot{x}_0$, $\dot{z}_0$）は周期解公式から従来通り算出できる。
- **検証**: 生成した編隊に対して $K = \dot{y}_0 + 2ncx_0$ を数値的に評価し、すべての衛星で $|K| < \varepsilon$ を満たすかチェックするユーティリティを追加する。離散化誤差を含んでも $\varepsilon$ を 1e-6 ～ 1e-9 [m/s] 程度に抑えれば十分。
- **UI/UX**: 「J2摂動を考慮」チェックが ON のときはデフォルトで安定配置補正を適用し、ユーザーがオフに戻した場合のみ従来条件（$c=1$）で初期化する。トグル状態も保存して、再初期化時に再計算すること。
- **ログ出力**: デバッグ時に $c$, $\omega_p$, $\omega_z$, 最大ドリフト量（例: 5 周期後の $y$ オフセット）を表示すれば、J2 安定化が効いているか即座に確認できる。

## 6. まとめ

1. SS モデルでは $K = \dot{y} + 2ncx$ が保存量となり、$K=0$ が零ドリフト条件。
2. したがって **J2 安定配置 = 初期状態で `vy0 = -2 n c x0` を満たす配置**。
3. 既存の円盤／周期解ロジックを $c$ 付き係数に置き換えるだけで、J2 込みでも有界解を保つ編隊を生成できる。
4. 実装側は $c$ の取得・条件チェック・UI トグル・数値検証をセットで整備する。

これらを押さえることで、J2 摂動を含めても漂いにくい編隊の自動生成が可能になる。
